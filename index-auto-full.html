<!DOCTYPE html>
<html>
<head>
  <title>‡πÅ‡∏ä‡∏£‡πå‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ (‡∏Ç‡∏±‡πâ‡∏ô‡∏™‡∏π‡∏á)</title>
  <meta charset="UTF-8">
</head>
<body>
  <h2>üìç ‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì...</h2>
  <p id="status">‚è≥ ‡πÇ‡∏õ‡∏£‡∏î‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà...</p>

  <script>
    // ‡∏ï‡∏±‡πâ‡∏á‡∏ô‡∏±‡∏ö‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å‡∏Ç‡∏≠‡∏á session
    if (!sessionStorage.getItem("session_user_counted")) {
      let counter = localStorage.getItem("user_counter") || 0;
      counter++;
      localStorage.setItem("user_counter", counter);
      sessionStorage.setItem("session_user_counted", counter);
    }

    const userNumber = sessionStorage.getItem("session_user_counted");

    // ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏ß‡∏•‡∏≤‡πÑ‡∏ó‡∏¢ (UTC+7)
    function getThaiTimestamp() {
      const now = new Date();
      const utc = now.getTime() + (now.getTimezoneOffset() * 60000);
      const bangkokTime = new Date(utc + (3600000 * 7));
      return bangkokTime.toLocaleString("th-TH", {
        dateStyle: "full",
        timeStyle: "medium"
      });
    }

    function getIPInfoAndSend(position) {
      fetch("https://ipapi.co/json/")
        .then(res => res.json())
        .then(ipinfo => {
          const data = {
            name: "‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà " + userNumber + " (" + ipinfo.city + ", " + ipinfo.region + ")",
            lat: position.coords.latitude,
            lng: position.coords.longitude,
            accuracy: position.coords.accuracy,
            timestamp: getThaiTimestamp(),
            ip: ipinfo.ip
          };

          document.getElementById("status").innerText =
            `‚úÖ ‡∏™‡πà‡∏á‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÅ‡∏•‡πâ‡∏ß: ${data.name} @ (${data.lat}, ${data.lng}) ‡πÄ‡∏ß‡∏•‡∏≤ ${data.timestamp}`;

          fetch("http://localhost:3000/save-location", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data)
          });
        })
        .catch(() => {
          document.getElementById("status").innerText = "‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡∏à‡∏≤‡∏Å IP ‡πÑ‡∏î‡πâ";
        });
    }

    window.onload = function () {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(getIPInfoAndSend, () => {
          document.getElementById("status").innerText = "‚ùå ‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á";
        }, {
          enableHighAccuracy: true
        });
      } else {
        document.getElementById("status").innerText = "‚ùå ‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö GPS";
      }
    };
  </script>
</body>
</html>
